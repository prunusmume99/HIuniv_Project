import json
import os
import numpy as np
import pandas as pd
import matplotlib as mpl
import matplotlib.font_manager as fm
import folium
import random
from folium.features import GeoJsonTooltip
from branca.element import Template, MacroElement, Element
import branca.colormap as cm

# ---------------------------
# 0) ê¸€ë¡œë²Œ ì„¤ì •: í•œê¸€ í°íŠ¸ & ìŒìˆ˜ ê¸°í˜¸
# ---------------------------
for f in ['Malgun Gothic', 'AppleGothic', 'NanumGothic']:
    if any(ft.name == f for ft in fm.fontManager.ttflist):
        mpl.rcParams['font.family'] = f
        break
mpl.rcParams['axes.unicode_minus'] = False  # ìŒìˆ˜ ê¹¨ì§ ë°©ì§€

# ---------------------------
# 1) GeoJSON ë¡œë“œ ë° ê²°í•© (ì „êµ­ ë‹¨ìœ„)
# ---------------------------
paths = {
    'ì„¸ì¢…': '../data/raw/hangjeongdong_ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ.geojson',
    'ê²½ë¶': '../data/raw/hangjeongdong_ê²½ìƒë¶ë„.geojson',
    'ê°•ì›': '../data/raw/hangjeongdong_ê°•ì›ë„.geojson',
    'ê²½ê¸°': '../data/raw/hangjeongdong_ê²½ê¸°ë„.geojson',
    'ê²½ë‚¨': '../data/raw/hangjeongdong_ê²½ìƒë‚¨ë„.geojson',
    'ê´‘ì£¼': '../data/raw/hangjeongdong_ê´‘ì£¼ê´‘ì—­ì‹œ.geojson',
    'ëŒ€ì „': '../data/raw/hangjeongdong_ëŒ€ì „ê´‘ì—­ì‹œ.geojson',
    'ëŒ€êµ¬': '../data/raw/hangjeongdong_ëŒ€êµ¬ê´‘ì—­ì‹œ.geojson',
    'ì„œìš¸': '../data/raw/hangjeongdong_ì„œìš¸íŠ¹ë³„ì‹œ.geojson',
    'ë¶€ì‚°': '../data/raw/hangjeongdong_ë¶€ì‚°ê´‘ì—­ì‹œ.geojson',
    'ì¸ì²œ': '../data/raw/hangjeongdong_ì¸ì²œê´‘ì—­ì‹œ.geojson',
    'ìš¸ì‚°': '../data/raw/hangjeongdong_ìš¸ì‚°ê´‘ì—­ì‹œ.geojson',
    'ì œì£¼': '../data/raw/hangjeongdong_ì œì£¼íŠ¹ë³„ìì¹˜ë„.geojson',
    'ì „ë¶': '../data/raw/hangjeongdong_ì „ë¼ë¶ë„.geojson',
    'ì „ë‚¨': '../data/raw/hangjeongdong_ì „ë¼ë‚¨ë„.geojson',
    'ì¶©ë‚¨': '../data/raw/hangjeongdong_ì¶©ì²­ë‚¨ë„.geojson',
    'ì¶©ë¶': '../data/raw/hangjeongdong_ì¶©ì²­ë¶ë„.geojson',
}
geos = [json.load(open(p, encoding='utf-8')) for p in paths.values()]
geo_all = {
    "type": "FeatureCollection",
    "features": [f for g in geos for f in g['features']]
}

print(f"âœ… GeoJSON ë¡œë“œ ì™„ë£Œ: {len(geo_all['features'])}ê°œ í–‰ì •ë™")

# ---------------------------
# 2) ë°ì´í„° ë¡œë“œ ë° ì „ì²˜ë¦¬
# ---------------------------

# ì£¼ê±°ì·¨ì•½ì§€ìˆ˜ ë°ì´í„° ë¡œë“œ (ì‹œë„ë³„ ë°ì´í„°)
housing_data = pd.read_csv('../results/yunjin/housing_vulnerability_analysis.csv')
print(f"ğŸ  ì£¼ê±°ì·¨ì•½ì§€ìˆ˜ ë°ì´í„°: {len(housing_data)}ê°œ í–‰")

# ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜ ë°ì´í„° ë¡œë“œ (ì‹œêµ°êµ¬ë³„ ë°ì´í„°)
sewer_data = pd.read_csv('../results/yunjin/sewer_infrastructure_analysis_summary.csv')
print(f"ğŸ’§ ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜ ë°ì´í„°: {len(sewer_data)}ê°œ í–‰")

# ì‚¬íšŒì·¨ì•½ì§€ìˆ˜ ë°ì´í„° ë¡œë“œ (ìë©´ë™ë³„ ë°ì´í„°)
social_data = pd.read_csv('../data/processed/202506_ìë©´ë™_ì‚¬íšŒì·¨ì•½ê³„ì¸µí‘œ.csv')
print(f"ğŸ‘¥ ì‚¬íšŒì·¨ì•½ì§€ìˆ˜ ë°ì´í„°: {len(social_data)}ê°œ í–‰")

# ë°ì´í„° ì „ì²˜ë¦¬
# ì£¼ê±°ì·¨ì•½ì§€ìˆ˜: regionì„ ì‹œë„ëª…ìœ¼ë¡œ ì‚¬ìš© (ì‹œë„ë³„ ë°ì´í„°)
housing_data['ì‹œë„ëª…'] = housing_data['region']
housing_data['ì£¼ê±°ì·¨ì•½ì§€ìˆ˜'] = housing_data['vulnerability_normalized']

# ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜: ì‹œêµ°êµ¬ë³„ ë°ì´í„° ìœ ì§€
sewer_data['ì‹œë„ëª…'] = sewer_data['ì‹œë„']
sewer_data['ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜'] = sewer_data['í•˜ìˆ˜ë„_ì¸í”„ë¼_ì§€ìˆ˜']

# ì‚¬íšŒì·¨ì•½ì§€ìˆ˜: ìë©´ë™ë³„ ë°ì´í„° ìœ ì§€
social_data['ì‚¬íšŒì·¨ì•½ì§€ìˆ˜'] = social_data['ì‚¬íšŒì·¨ì•½ì§€ìˆ˜']

print("ğŸ“Š ë°ì´í„° ì „ì²˜ë¦¬ ì™„ë£Œ")

# ë“±ê¸‰ ê³„ì‚° í•¨ìˆ˜
def calculate_grade(value, bins):
    if pd.isna(value):
        return 1
    for i in range(1, len(bins)):
        if value < bins[i]:
            return i
    return len(bins) - 1

# ì£¼ê±°ì·¨ì•½ì§€ìˆ˜ ë“±ê¸‰ (70/50/30/10 ê¸°ì¤€ìœ¼ë¡œ 5ë“±ê¸‰)
housing_bins = [0, 10, 30, 50, 70, 100]
housing_data['ì£¼ê±°ì·¨ì•½ë“±ê¸‰'] = housing_data['ì£¼ê±°ì·¨ì•½ì§€ìˆ˜'].apply(lambda x: calculate_grade(x, housing_bins))

# ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜ ë“±ê¸‰ (80/60/40 ê¸°ì¤€ìœ¼ë¡œ 4ë“±ê¸‰)
sewer_bins = [0, 40, 60, 80, 100]
sewer_data['ìˆ˜ë„ì¸í”„ë¼ë“±ê¸‰'] = sewer_data['ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜'].apply(lambda x: calculate_grade(x, sewer_bins))

# ì‚¬íšŒì·¨ì•½ì§€ìˆ˜ ë“±ê¸‰ (25/50/75 ê¸°ì¤€ìœ¼ë¡œ 4ë“±ê¸‰)
social_bins = [0, 25, 50, 75, 100]
social_data['ì‚¬íšŒì·¨ì•½ë“±ê¸‰'] = social_data['ì‚¬íšŒì·¨ì•½ì§€ìˆ˜'].apply(lambda x: calculate_grade(x, social_bins))

print("ğŸ“Š ë“±ê¸‰ ê³„ì‚° ì™„ë£Œ")

# ë“±ê¸‰ë³„ ë¼ë²¨ ë§¤í•‘
def get_grade_label(grade, grade_type):
    if grade_type == "ì£¼ê±°ì·¨ì•½":
        labels = {1: "ë§¤ìš° ë‚®ìŒ", 2: "ë‚®ìŒ", 3: "ë³´í†µ", 4: "ë†’ìŒ", 5: "ë§¤ìš° ë†’ìŒ"}
    elif grade_type == "ìˆ˜ë„ì¸í”„ë¼":
        labels = {1: "ë§¤ìš° ë‚®ìŒ", 2: "ë‚®ìŒ", 3: "ë³´í†µ", 4: "ë†’ìŒ"}
    else:  # ì‚¬íšŒì·¨ì•½
        labels = {1: "ë§¤ìš° ë‚®ìŒ", 2: "ë‚®ìŒ", 3: "ë³´í†µ", 4: "ë†’ìŒ"}
    return labels.get(grade, "ë³´í†µ")

# ë“±ê¸‰ ë¼ë²¨ ì¶”ê°€
housing_data['ì£¼ê±°ì·¨ì•½ë“±ê¸‰ë¼ë²¨'] = housing_data['ì£¼ê±°ì·¨ì•½ë“±ê¸‰'].apply(lambda x: get_grade_label(x, "ì£¼ê±°ì·¨ì•½"))
sewer_data['ìˆ˜ë„ì¸í”„ë¼ë“±ê¸‰ë¼ë²¨'] = sewer_data['ìˆ˜ë„ì¸í”„ë¼ë“±ê¸‰'].apply(lambda x: get_grade_label(x, "ìˆ˜ë„ì¸í”„ë¼"))
social_data['ì‚¬íšŒì·¨ì•½ë“±ê¸‰ë¼ë²¨'] = social_data['ì‚¬íšŒì·¨ì•½ë“±ê¸‰'].apply(lambda x: get_grade_label(x, "ì‚¬íšŒì·¨ì•½"))

print("ğŸ“Š ë“±ê¸‰ ë¼ë²¨ ë§¤í•‘ ì™„ë£Œ")

# í–‰ì •ë™ëª… ë§¤í•‘ (GeoJSONì—ì„œ)
code2name = {
    str(f['properties']['adm_cd2']): f['properties']['adm_nm']
    for f in geo_all['features']
}

# ì‹œë„ëª… ì¶”ì¶œ (í–‰ì •ë™ëª… ê¸°ì¤€)
def sido_of(name):
    if not isinstance(name, str):
        return 'ê¸°íƒ€'
    
    # í–‰ì •ë™ëª…ì—ì„œ ì‹œë„ëª… ì¶”ì¶œ
    # ì˜ˆ: "ì„œìš¸íŠ¹ë³„ì‹œ ì¢…ë¡œêµ¬ ì‚¬ì§ë™" -> "ì„œìš¸íŠ¹ë³„ì‹œ"
    if ' ' in name:
        sido = name.split()[0]
    else:
        sido = name
    
    # ì‹œë„ëª… ë§¤í•‘
    sido_mapping = {
        'ì„œìš¸íŠ¹ë³„ì‹œ': 'ì„œìš¸íŠ¹ë³„ì‹œ',
        'ë¶€ì‚°ê´‘ì—­ì‹œ': 'ë¶€ì‚°ê´‘ì—­ì‹œ',
        'ëŒ€êµ¬ê´‘ì—­ì‹œ': 'ëŒ€êµ¬ê´‘ì—­ì‹œ',
        'ì¸ì²œê´‘ì—­ì‹œ': 'ì¸ì²œê´‘ì—­ì‹œ',
        'ê´‘ì£¼ê´‘ì—­ì‹œ': 'ê´‘ì£¼ê´‘ì—­ì‹œ',
        'ëŒ€ì „ê´‘ì—­ì‹œ': 'ëŒ€ì „ê´‘ì—­ì‹œ',
        'ìš¸ì‚°ê´‘ì—­ì‹œ': 'ìš¸ì‚°ê´‘ì—­ì‹œ',
        'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ': 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ',
        'ê²½ê¸°ë„': 'ê²½ê¸°ë„',
        'ê°•ì›ë„': 'ê°•ì›ë„',
        'ì¶©ì²­ë¶ë„': 'ì¶©ì²­ë¶ë„',
        'ì¶©ì²­ë‚¨ë„': 'ì¶©ì²­ë‚¨ë„',
        'ì „ë¼ë¶ë„': 'ì „ë¼ë¶ë„',
        'ì „ë¼ë‚¨ë„': 'ì „ë¼ë‚¨ë„',
        'ê²½ìƒë¶ë„': 'ê²½ìƒë¶ë„',
        'ê²½ìƒë‚¨ë„': 'ê²½ìƒë‚¨ë„',
        'ì œì£¼íŠ¹ë³„ìì¹˜ë„': 'ì œì£¼íŠ¹ë³„ìì¹˜ë„'
    }
    
    return sido_mapping.get(sido, 'ê¸°íƒ€')

print(f"ğŸ“ ì§€ë¦¬ì •ë³´ ë§¤í•‘ ì¤€ë¹„ ì™„ë£Œ")

# ---------------------------
# 3) GeoJSON featureì— ê°œë³„ ë°ì´í„° ì†ì„± ë³‘í•©
# ---------------------------

# ë°ì´í„°ë¥¼ í–‰ì •ë™ì½”ë“œ ê¸°ì¤€ìœ¼ë¡œ ë”•ì…”ë„ˆë¦¬ë¡œ ë³€í™˜
housing_dict = housing_data.set_index('region').to_dict(orient='index')

# ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜: ì‹œêµ°êµ¬ë³„ ë°ì´í„°ë¥¼ ë”•ì…”ë„ˆë¦¬ë¡œ ë³€í™˜
# ì¤‘ë³µ ì œê±° í›„ ë”•ì…”ë„ˆë¦¬ ìƒì„±
sewer_data_unique = sewer_data.drop_duplicates(subset=['ì‹œë„', 'í–‰ì •êµ¬ì—­ëª…']).copy()
sewer_dict = sewer_data_unique.set_index(['ì‹œë„', 'í–‰ì •êµ¬ì—­ëª…']).to_dict(orient='index')

# ì‚¬íšŒì·¨ì•½ì§€ìˆ˜: ìë©´ë™ë³„ ë°ì´í„°ë¥¼ ë”•ì…”ë„ˆë¦¬ë¡œ ë³€í™˜
# ì¤‘ë³µ ì œê±° í›„ ë”•ì…”ë„ˆë¦¬ ìƒì„±
social_data_unique = social_data.drop_duplicates(subset=['í–‰ì •ë™ì½”ë“œ']).copy()
social_dict = social_data_unique.set_index('í–‰ì •ë™ì½”ë“œ').to_dict(orient='index')

# ë””ë²„ê¹…: ë”•ì…”ë„ˆë¦¬ í‚¤ í™•ì¸
print("=== ë”•ì…”ë„ˆë¦¬ í‚¤ í™•ì¸ ===")
print(f"ì£¼ê±°ì·¨ì•½ì§€ìˆ˜ í‚¤: {list(housing_dict.keys())[:5]}")
print(f"ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜ í‚¤: {list(sewer_dict.keys())[:5]}")
print(f"ì‚¬íšŒì·¨ì•½ì§€ìˆ˜ í‚¤: {list(social_dict.keys())[:5]}")

# ê¸°ë³¸ê°’ ì„¤ì •
empty = {
    'ì£¼ê±°ì·¨ì•½ì§€ìˆ˜': 50,
    'ì£¼ê±°ì·¨ì•½ë“±ê¸‰': 3,
    'ì£¼ê±°ì·¨ì•½ë“±ê¸‰ë¼ë²¨': 'ë³´í†µ',
    'ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜': 50,
    'ìˆ˜ë„ì¸í”„ë¼ë“±ê¸‰': 3,
    'ìˆ˜ë„ì¸í”„ë¼ë“±ê¸‰ë¼ë²¨': 'ë³´í†µ',
    'ì‚¬íšŒì·¨ì•½ì§€ìˆ˜': 50,
    'ì‚¬íšŒì·¨ì•½ë“±ê¸‰': 3,
    'ì‚¬íšŒì·¨ì•½ë“±ê¸‰ë¼ë²¨': 'ë³´í†µ',
    'í–‰ì •ë™ëª…': 'ê¸°íƒ€',
    'ì‹œë„ëª…': 'ê¸°íƒ€'
}

# ë§¤í•‘ ì„±ê³µ/ì‹¤íŒ¨ í†µê³„
mapping_stats = {
    'social_success': 0,
    'social_failed': 0,
    'sewer_success': 0,
    'sewer_failed': 0,
    'housing_success': 0,
    'housing_failed': 0
}

for feat in geo_all['features']:
    adm_cd2 = str(feat['properties'].get('adm_cd2', ''))
    adm_nm = feat['properties'].get('adm_nm', '')
    sido_name = sido_of(adm_nm)
    
    # ì‚¬íšŒì·¨ì•½ì§€ìˆ˜ (ìë©´ë™ë³„ ê°œë³„ ë°ì´í„°)
    social_row = social_dict.get(adm_cd2)
    if social_row:
        social_vuln = social_row.get('ì‚¬íšŒì·¨ì•½ì§€ìˆ˜', 50)
        social_grade = social_row.get('ì‚¬íšŒì·¨ì•½ë“±ê¸‰', 3)
        social_grade_label = social_row.get('ì‚¬íšŒì·¨ì•½ë“±ê¸‰ë¼ë²¨', 'ë³´í†µ')
        mapping_stats['social_success'] += 1
    else:
        social_vuln = 50
        social_grade = 3
        social_grade_label = 'ë³´í†µ'
        mapping_stats['social_failed'] += 1
    
    # ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜ (ì‹œêµ°êµ¬ë³„ ë°ì´í„° - ì‹œë„ì™€ ì‹œêµ°êµ¬ëª…ìœ¼ë¡œ ë§¤í•‘)
    # ì‹œêµ°êµ¬ëª…ì—ì„œ êµ¬/êµ°/ì‹œ ì¶”ì¶œ
    sigungu_name = adm_nm.split()[1] if len(adm_nm.split()) > 1 else adm_nm
    sewer_key = (sido_name, sigungu_name)
    sewer_row = sewer_dict.get(sewer_key)
    if sewer_row:
        sewer_infra = sewer_row.get('ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜', 50)
        sewer_grade = sewer_row.get('ìˆ˜ë„ì¸í”„ë¼ë“±ê¸‰', 3)
        sewer_grade_label = sewer_row.get('ìˆ˜ë„ì¸í”„ë¼ë“±ê¸‰ë¼ë²¨', 'ë³´í†µ')
        mapping_stats['sewer_success'] += 1
    else:
        sewer_infra = 50
        sewer_grade = 3
        sewer_grade_label = 'ë³´í†µ'
        mapping_stats['sewer_failed'] += 1
    
    # ì£¼ê±°ì·¨ì•½ì§€ìˆ˜ (ì‹œë„ë³„ ë°ì´í„° - í•´ë‹¹ ì‹œë„ì˜ ê°’ ì‚¬ìš©)
    housing_row = housing_dict.get(sido_name)
    if housing_row:
        housing_vuln = housing_row.get('ì£¼ê±°ì·¨ì•½ì§€ìˆ˜', 50)
        housing_grade = housing_row.get('ì£¼ê±°ì·¨ì•½ë“±ê¸‰', 3)
        housing_grade_label = housing_row.get('ì£¼ê±°ì·¨ì•½ë“±ê¸‰ë¼ë²¨', 'ë³´í†µ')
        mapping_stats['housing_success'] += 1
    else:
        housing_vuln = 50
        housing_grade = 3
        housing_grade_label = 'ë³´í†µ'
        mapping_stats['housing_failed'] += 1
    
    # ë””ë²„ê¹…: ì²˜ìŒ ëª‡ ê°œë§Œ ì¶œë ¥
    if len([f for f in geo_all['features'] if f == feat]) <= 3:
        print(f"ë§¤í•‘ ë””ë²„ê¹…: {adm_nm} (ì½”ë“œ: {adm_cd2})")
        print(f"  - ì‹œë„: {sido_name}")
        print(f"  - ì‚¬íšŒì·¨ì•½ì§€ìˆ˜: {social_vuln} (ë“±ê¸‰: {social_grade}, ë¼ë²¨: {social_grade_label}) (ë§¤í•‘ë¨: {social_row is not None})")
        print(f"  - ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜: {sewer_infra} (ë“±ê¸‰: {sewer_grade}, ë¼ë²¨: {sewer_grade_label}) (í‚¤: {sewer_key}, ë§¤í•‘ë¨: {sewer_row is not None})")
        print(f"  - ì£¼ê±°ì·¨ì•½ì§€ìˆ˜: {housing_vuln} (ë“±ê¸‰: {housing_grade}, ë¼ë²¨: {housing_grade_label}) (ë§¤í•‘ë¨: {housing_row is not None})")
    
    feat['properties'].update({
        'ì£¼ê±°ì·¨ì•½ì§€ìˆ˜': housing_vuln,
        'ì£¼ê±°ì·¨ì•½ë“±ê¸‰': housing_grade,
        'ì£¼ê±°ì·¨ì•½ë“±ê¸‰ë¼ë²¨': housing_grade_label,
        'ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜': sewer_infra,
        'ìˆ˜ë„ì¸í”„ë¼ë“±ê¸‰': sewer_grade,
        'ìˆ˜ë„ì¸í”„ë¼ë“±ê¸‰ë¼ë²¨': sewer_grade_label,
        'ì‚¬íšŒì·¨ì•½ì§€ìˆ˜': social_vuln,
        'ì‚¬íšŒì·¨ì•½ë“±ê¸‰': social_grade,
        'ì‚¬íšŒì·¨ì•½ë“±ê¸‰ë¼ë²¨': social_grade_label,
        'í–‰ì •ë™ëª…': adm_nm,
        'ì‹œë„ëª…': sido_name,
    })

print("âœ… GeoJSON ë°ì´í„° ë³‘í•© ì™„ë£Œ")

# ë§¤í•‘ í†µê³„ ì¶œë ¥
print("=== ë§¤í•‘ í†µê³„ ===")
print(f"ì‚¬íšŒì·¨ì•½ì§€ìˆ˜ ë§¤í•‘ ì„±ê³µ: {mapping_stats['social_success']}, ì‹¤íŒ¨: {mapping_stats['social_failed']}")
print(f"ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜ ë§¤í•‘ ì„±ê³µ: {mapping_stats['sewer_success']}, ì‹¤íŒ¨: {mapping_stats['sewer_failed']}")
print(f"ì£¼ê±°ì·¨ì•½ì§€ìˆ˜ ë§¤í•‘ ì„±ê³µ: {mapping_stats['housing_success']}, ì‹¤íŒ¨: {mapping_stats['housing_failed']}")

# ë°ì´í„° ê°’ ë²”ìœ„ í™•ì¸
print("ë°ì´í„° ê°’ ë²”ìœ„:")
print(f"ì‚¬íšŒì·¨ì•½ì§€ìˆ˜: {social_data['ì‚¬íšŒì·¨ì•½ì§€ìˆ˜'].min():.2f} ~ {social_data['ì‚¬íšŒì·¨ì•½ì§€ìˆ˜'].max():.2f}")
print(f"ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜: {sewer_data['ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜'].min():.2f} ~ {sewer_data['ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜'].max():.2f}")
print(f"ì£¼ê±°ì·¨ì•½ì§€ìˆ˜: {housing_data['ì£¼ê±°ì·¨ì•½ì§€ìˆ˜'].min():.2f} ~ {housing_data['ì£¼ê±°ì·¨ì•½ì§€ìˆ˜'].max():.2f}")

# ---------------------------
# 4) ì§€í‘œ ì„¤ì • (3ê°€ì§€ ì§€ìˆ˜)
# ---------------------------
METRICS = {
    "ì£¼ê±°ì·¨ì•½ì§€ìˆ˜": dict(
        col="ì£¼ê±°ì·¨ì•½ì§€ìˆ˜",
        palette="Reds",
        bins=[0, 10, 30, 50, 70, 100],
        fmt="{:.1f}",
        chart_color="#e31a1c"  # ë¹¨ê°•
    ),
    "ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜": dict(
        col="ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜",
        palette="Blues",
        bins=[0, 40, 60, 80, 100],
        fmt="{:.1f}",
        chart_color="#1f78b4"  # íŒŒë‘
    ),
    "ì‚¬íšŒì·¨ì•½ì§€ìˆ˜": dict(
        col="ì‚¬íšŒì·¨ì•½ì§€ìˆ˜",
        palette="Purples",
        bins=[0, 25, 50, 75, 100],
        fmt="{:.1f}",
        chart_color="#6a3d9a"  # ë³´ë¼
    ),
}

print("ğŸ“Š ì§€í‘œ ì„¤ì • ì™„ë£Œ")

# ---------------------------
# 5) Folium ì§€ë„ ìƒì„± ë° GeoJson ë ˆì´ì–´ ì¶”ê°€
# ---------------------------
m = folium.Map(location=[36, 127], zoom_start=7,
               tiles='cartodbpositron', control_scale=True)

# ìƒ‰ìƒ ë§µ ìƒì„±
def get_color_map(palette, bins):
    if palette == "Reds":
        return cm.LinearColormap(['#fee5d9', '#fcae91', '#fb6a4a', '#de2d26', '#a50f15'], vmin=bins[0], vmax=bins[-1])
    elif palette == "Blues":
        return cm.LinearColormap(['#deebf7', '#c6dbef', '#9ecae1', '#6baed6', '#3182bd'], vmin=bins[0], vmax=bins[-1])
    elif palette == "Purples":
        return cm.LinearColormap(['#f2f0f7', '#cbc9e2', '#9e9ac8', '#756bb1', '#54278f'], vmin=bins[0], vmax=bins[-1])
    else:
        return cm.LinearColormap(['#f7f7f7', '#cccccc', '#969696', '#636363', '#252525'], vmin=bins[0], vmax=bins[-1])

layer_js_refs = {}
for i, (title, cfg) in enumerate(METRICS.items(), start=1):
    # ìƒ‰ìƒ ë§µ ìƒì„±
    color_map = get_color_map(cfg['palette'], cfg['bins'])
    
    # ìŠ¤íƒ€ì¼ í•¨ìˆ˜ ì •ì˜
    def style_function(feature):
        value = feature['properties'].get(cfg['col'], 50)
        if pd.isna(value):
            return {'fillColor': '#fde0dd', 'fillOpacity': 0.7, 'color': '#000', 'weight': 0.5}
        return {
            'fillColor': color_map(value),
            'fillOpacity': 0.7,
            'color': '#000',
            'weight': 0.5
        }
    
    # GeoJson ë ˆì´ì–´ ìƒì„±
    geojson_layer = folium.GeoJson(
        geo_all,
        name=title,
        style_function=style_function,
        tooltip=GeoJsonTooltip(
            fields=['adm_nm', cfg['col'], f'{title.replace("ì§€ìˆ˜", "ë“±ê¸‰")}'],
            aliases=['í–‰ì •ë™', title, 'ë“±ê¸‰'],
            localize=True,
            labels=True,
            sticky=False,
            style=(
                "background-color:rgba(255,255,255,.9);"
                "border:1px solid #999;border-radius:3px;"
                "box-shadow:2px 2px 6px rgba(0,0,0,.15);"
                "font-size:12px;padding:4px;"
            )
        ),
        show=(i == 1)
    ).add_to(m)
    
    # ë²”ë¡€ ì¶”ê°€
    color_map.caption = title
    m.add_child(color_map)
    
    layer_js_refs[title] = geojson_layer.get_name()

print("ğŸ—ºï¸ ì§€ë„ ë ˆì´ì–´ ìƒì„± ì™„ë£Œ")

# ---------------------------
# 6) ì°¨íŠ¸ ë° ë²„íŠ¼ìš© ë°ì´í„° ì¤€ë¹„
# ---------------------------
# Chart.js ë¡œë”© (ì¤‘ë³µ ë°©ì§€)
if not any("chart.js" in s.render().lower() for s in m.get_root().header._children.values()):
    m.get_root().header.add_child(
        Element('<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>')
    )

# metric Ã— ì‹œë„(ì „êµ­ í¬í•¨) top10 êµ¬ì¡° ìƒì„±
province_data = {}

# ì£¼ê±°ì·¨ì•½ì§€ìˆ˜ (ì‹œë„ë³„ ë°ì´í„°)
housing_top = housing_data.nlargest(10, 'ì£¼ê±°ì·¨ì•½ì§€ìˆ˜')
province_data["ì£¼ê±°ì·¨ì•½ì§€ìˆ˜"] = {
    'ì „êµ­': {
        'labels': housing_top['ì‹œë„ëª…'].tolist(),
        'values': housing_top['ì£¼ê±°ì·¨ì•½ì§€ìˆ˜'].tolist()
    }
}

# ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜ (ìë©´ë™ë³„ ë°ì´í„° - ì‹œë„ë³„ í‰ê· )
sewer_by_sido = sewer_data.groupby('ì‹œë„ëª…')['ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜'].mean().reset_index()
sewer_top = sewer_by_sido.nlargest(10, 'ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜')
province_data["ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜"] = {
    'ì „êµ­': {
        'labels': sewer_top['ì‹œë„ëª…'].tolist(),
        'values': sewer_top['ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜'].tolist()
    }
}

# ì‚¬íšŒì·¨ì•½ì§€ìˆ˜ (ìë©´ë™ë³„ ë°ì´í„° - ì‹œë„ë³„ í‰ê· )
social_by_sido = social_data.groupby('ì‹œë„ëª…')['ì‚¬íšŒì·¨ì•½ì§€ìˆ˜'].mean().reset_index()
social_top = social_by_sido.nlargest(10, 'ì‚¬íšŒì·¨ì•½ì§€ìˆ˜')
province_data["ì‚¬íšŒì·¨ì•½ì§€ìˆ˜"] = {
    'ì „êµ­': {
        'labels': social_top['ì‹œë„ëª…'].tolist(),
        'values': social_top['ì‚¬íšŒì·¨ì•½ì§€ìˆ˜'].tolist()
    }
}

# metric ìŠ¤íƒ€ì¼: ì ‘ë¯¸ì‚¬, ìƒ‰
metric_styles = {}
for k, v in METRICS.items():
    suffix = v['fmt'].replace("{:.1f}", "")
    metric_styles[k] = {
        'suffix': suffix,
        'color': v.get('chart_color', '#888888')
    }

# JS ì§ë ¬í™”
province_js = json.dumps(province_data, ensure_ascii=False)
metric_styles_js = json.dumps(metric_styles, ensure_ascii=False)
layer_dict_js = json.dumps(layer_js_refs, ensure_ascii=False)

# ë²„íŠ¼ HTML êµ¬ì„±
layer_btns_html = ''.join(f'<button class="layer-btn" data-layer="{k}">{k}</button>' for k in METRICS.keys())
sample_provinces = ['ì „êµ­']  # ê°„ë‹¨í•˜ê²Œ ì „êµ­ë§Œ í‘œì‹œ
sido_btns_html = ''.join(f'<button class="sido-btn" data-sido="{k}">{k}</button>' for k in sample_provinces)

print("ğŸ“Š ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ")

# ---------------------------
# 7) HTML/JS ë§¤í¬ë¡œ: ë ˆì´ì–´ ì„ íƒ + ì°¨íŠ¸ íŒ¨ë„
# ---------------------------

# ì™¼ìª½ metric ë²„íŠ¼ íŒ¨ë„
layer_template = f"""
{{% macro html(this, kwargs) %}}
<style>
  #layer-panel {{
      position:absolute; top:100px; left:10px; z-index:9999;
      background:#fff; padding:10px 16px; border-radius:14px;
      box-shadow:0 4px 20px rgba(0,0,0,.15);
      display:flex; gap:8px; font-family:'Segoe UI','NanumGothic',sans-serif;
  }}
  .layer-btn {{
      border:none; border-radius:16px; padding:8px 18px;
      font-size:13px; background:#f0f0f1; cursor:pointer;
      transition:all .2s ease;
      color:#444;
  }}
  .layer-btn:hover {{ filter:brightness(1.05); }}
</style>
<div id="layer-panel">
  {layer_btns_html}
</div>
{{% endmacro %}}

{{% macro script(this, kwargs) %}}
const layerDict = {layer_dict_js};
const mapObj = {{% raw %}}{m.get_name()}{{% endraw %}};

if (!window.metricStyles) {{
    window.metricStyles = {metric_styles_js};
}}

window.currentMetric = "ì‚¬íšŒì·¨ì•½ì§€ìˆ˜";
window.currentProvince = "ì „êµ­";
window.currentLayer = layerDict["ì‚¬íšŒì·¨ì•½ì§€ìˆ˜"];

function showLayer(key) {{
    const newLayer = layerDict[key];
    if (window.currentLayer === newLayer) return;
    Object.values(layerDict).forEach(id => {{
        const layer = window[id];
        if (mapObj.hasLayer(layer)) mapObj.removeLayer(layer);
    }});
    mapObj.addLayer(window[newLayer]);
    window.currentLayer = newLayer;
}}

document.getElementById('layer-panel').addEventListener('click', e => {{
    if (!e.target.classList.contains('layer-btn')) return;
    const layerKey = e.target.dataset.layer;

    document.querySelectorAll('.layer-btn').forEach(b => {{
        b.style.background = '#f0f0f1';
        b.style.color = '#444';
    }});
    e.target.style.background = window.metricStyles[layerKey].color;
    e.target.style.color = '#fff';

    window.currentMetric = layerKey;
    showLayer(layerKey);
    if (typeof window.updateChart === 'function') {{
        window.updateChart(window.currentMetric, window.currentProvince || 'ì „êµ­');
    }}

    const activeSido = document.querySelector('.sido-btn.active');
    if (activeSido) {{
        activeSido.style.background = window.metricStyles[layerKey].color;
        activeSido.style.color = '#fff';
    }}
}});
{{% endmacro %}}
"""

# ì˜¤ë¥¸ìª½ ì°¨íŠ¸ + ì‹œë„ ì„ íƒ íŒ¨ë„
chart_template = f"""
{{% macro html(this, kwargs) %}}
<style>
  #vuln-panel {{
      position:absolute; top:170px; right:10px; z-index:9999;
      width:440px; background:#fff; padding:16px;
      border-radius:14px; box-shadow:0 6px 26px rgba(0,0,0,.18);
      font-family:'Segoe UI','NanumGothic',sans-serif;
  }}
  #sido-buttons {{
      display:flex; flex-wrap:wrap; gap:8px; justify-content:center;
      margin-top:12px;
  }}
  .sido-btn {{
      padding:8px 18px; font-size:13px; border:none; border-radius:18px;
      background:#f6f6f7; color:#444; cursor:pointer;
      box-shadow:0 1px 3px rgba(0,0,0,.08);
      transition:all .2s ease;
  }}
  .sido-btn:hover {{ filter:brightness(1.05); }}
</style>
<div id="vuln-panel">
  <canvas id="barChart" width="400" height="260"></canvas>
  <div id="sido-buttons">{sido_btns_html}</div>
</div>
{{% endmacro %}}

{{% macro script(this, kwargs) %}}
const provinceData = {province_js};

if (!window.metricStyles) {{
    window.metricStyles = {metric_styles_js};
}}

window.currentMetric = window.currentMetric || "ì‚¬íšŒì·¨ì•½ì§€ìˆ˜";
window.currentProvince = window.currentProvince || "ì „êµ­";

const ctx = document.getElementById('barChart').getContext('2d');
const initData = (provinceData[window.currentMetric] && provinceData[window.currentMetric][window.currentProvince])
    ? provinceData[window.currentMetric][window.currentProvince]
    : provinceData[window.currentMetric]['ì „êµ­'];
const initStyle = window.metricStyles[window.currentMetric] || {{suffix:'', color:'#888'}};

const chart = new Chart(ctx, {{
    type: 'bar',
    data: {{
        labels: initData.labels,
        datasets: [{{ data: initData.values, backgroundColor: initStyle.color }}]
    }},
    options: {{
        indexAxis: 'y',
        scales: {{ x: {{ beginAtZero: true }} }},
        plugins: {{
            legend: {{ display: false }},
            tooltip: {{
                callbacks: {{
                    label: c => {{
                        const suffix = (window.metricStyles[window.currentMetric] || {{suffix:''}}).suffix;
                        return c.parsed.x + suffix;
                    }}
                }}
            }}
        }}
    }}
}});

window.updateChart = function(metric, province) {{
    window.currentMetric = metric;
    if (province) window.currentProvince = province;

    const pdata = (provinceData[metric] && provinceData[metric][window.currentProvince])
        ? provinceData[metric][window.currentProvince]
        : provinceData[metric]['ì „êµ­'];
    const style = window.metricStyles[metric] || {{suffix:'', color:'#888'}};

    chart.data.labels = pdata.labels;
    chart.data.datasets[0].data = pdata.values;
    chart.data.datasets[0].backgroundColor = style.color;
    chart.update();

    document.querySelectorAll('.sido-btn').forEach(b => {{
        if (b.classList.contains('active')) {{
            b.style.background = style.color;
            b.style.color = '#fff';
        }} else {{
            b.style.background = '#f6f6f7';
            b.style.color = '#444';
        }}
    }});
}};

document.getElementById('sido-buttons').addEventListener('click', e => {{
    if (!e.target.classList.contains('sido-btn')) return;
    const key = e.target.dataset.sido;

    document.querySelectorAll('.sido-btn').forEach(b => {{
        b.classList.remove('active');
        b.style.background = '#f6f6f7';
        b.style.color = '#444';
    }});
    e.target.classList.add('active');

    const currStyle = window.metricStyles[window.currentMetric] || {{color:'#888'}};
    e.target.style.background = currStyle.color;
    e.target.style.color = '#fff';

    window.currentProvince = key;
    window.updateChart(window.currentMetric, window.currentProvince);
}});
{{% endmacro %}}
"""

print("ğŸ¨ UI í…œí”Œë¦¿ ì¤€ë¹„ ì™„ë£Œ")

# ---------------------------
# 8) ë§¤í¬ë¡œë¥¼ Folium ì§€ë„ì— ë¶™ì´ê¸°
# ---------------------------
layer_panel = MacroElement()
layer_panel._template = Template(layer_template)
m.get_root().add_child(layer_panel)

chart_panel = MacroElement()
chart_panel._template = Template(chart_template)
m.get_root().add_child(chart_panel)

print("âœ… UI íŒ¨ë„ ì¶”ê°€ ì™„ë£Œ")

# ---------------------------
# 9) ë ˆì´ì–´ ì»¨íŠ¸ë¡¤ ë° HTML ì €ì¥
# ---------------------------
folium.LayerControl(collapsed=True).add_to(m)

# ê²°ê³¼ ì €ì¥
output_path = '../results/integrated_housing_sewer_social_map.html'
os.makedirs(os.path.dirname(output_path), exist_ok=True)
m.save(output_path)

print(f"âœ… ì§€ë„ ì €ì¥ ì™„ë£Œ: {output_path}")
print(f"ğŸ“Š í†µí•© ë°ì´í„° ìš”ì•½:")
print(f"  â€¢ ì´ í–‰ì •ë™: {len(geo_all['features'])}ê°œ")
print(f"  â€¢ ì£¼ê±°ì·¨ì•½ì§€ìˆ˜: ì‹œë„ë³„ ë°ì´í„° ({len(housing_data)}ê°œ)")
print(f"  â€¢ ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜: ìë©´ë™ë³„ ë°ì´í„° ({len(sewer_data_unique)}ê°œ)")
print(f"  â€¢ ì‚¬íšŒì·¨ì•½ì§€ìˆ˜: ìë©´ë™ë³„ ë°ì´í„° ({len(social_data_unique)}ê°œ)") 