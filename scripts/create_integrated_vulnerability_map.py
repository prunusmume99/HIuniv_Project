import json
import os
import numpy as np
import pandas as pd
import matplotlib as mpl
import matplotlib.font_manager as fm
import folium
import random
import re
from folium.features import GeoJsonTooltip
from branca.element import Template, MacroElement, Element

# ---------------------------
# 0) ê¸€ë¡œë²Œ ì„¤ì •: í•œê¸€ í°íŠ¸ & ìŒìˆ˜ ê¸°í˜¸
# ---------------------------
for f in ['Malgun Gothic', 'AppleGothic', 'NanumGothic']:
    if any(ft.name == f for ft in fm.fontManager.ttflist):
        mpl.rcParams['font.family'] = f
        break
mpl.rcParams['axes.unicode_minus'] = False  # ìŒìˆ˜ ê¹¨ì§ ë°©ì§€

# ---------------------------
# 1) GeoJSON ë¡œë“œ ë° ê²°í•© (ì „êµ­ ë‹¨ìœ„)
# ---------------------------
paths = {
    'ì„¸ì¢…': 'data/raw/hangjeongdong_ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ.geojson',
    'ê²½ë¶': 'data/raw/hangjeongdong_ê²½ìƒë¶ë„.geojson',
    'ê°•ì›': 'data/raw/hangjeongdong_ê°•ì›ë„.geojson',
    'ê²½ê¸°': 'data/raw/hangjeongdong_ê²½ê¸°ë„.geojson',
    'ê²½ë‚¨': 'data/raw/hangjeongdong_ê²½ìƒë‚¨ë„.geojson',
    'ê´‘ì£¼': 'data/raw/hangjeongdong_ê´‘ì£¼ê´‘ì—­ì‹œ.geojson',
    'ëŒ€ì „': 'data/raw/hangjeongdong_ëŒ€ì „ê´‘ì—­ì‹œ.geojson',
    'ëŒ€êµ¬': 'data/raw/hangjeongdong_ëŒ€êµ¬ê´‘ì—­ì‹œ.geojson',
    'ì„œìš¸': 'data/raw/hangjeongdong_ì„œìš¸íŠ¹ë³„ì‹œ.geojson',
    'ë¶€ì‚°': 'data/raw/hangjeongdong_ë¶€ì‚°ê´‘ì—­ì‹œ.geojson',
    'ìš¸ì‚°': 'data/raw/hangjeongdong_ìš¸ì‚°ê´‘ì—­ì‹œ.geojson',
    'ì¸ì²œ': 'data/raw/hangjeongdong_ì¸ì²œê´‘ì—­ì‹œ.geojson',
    'ì „ë‚¨': 'data/raw/hangjeongdong_ì „ë¼ë‚¨ë„.geojson',
    'ì „ë¶': 'data/raw/hangjeongdong_ì „ë¼ë¶ë„.geojson',
    'ì œì£¼': 'data/raw/hangjeongdong_ì œì£¼íŠ¹ë³„ìì¹˜ë„.geojson',
    'ì¶©ë‚¨': 'data/raw/hangjeongdong_ì¶©ì²­ë‚¨ë„.geojson',
    'ì¶©ë¶': 'data/raw/hangjeongdong_ì¶©ì²­ë¶ë„.geojson',
}

geos = [json.load(open(p, encoding='utf-8')) for p in paths.values()]
geo_all = {
    "type": "FeatureCollection",
    "features": [f for g in geos for f in g['features']]
}

# ---------------------------
# 2) ê¸°ì¡´ ë°ì´í„° ë¡œë“œ
# ---------------------------
# ê¸°ì¡´ ì·¨ì•½ì„± ë°ì´í„° ë¡œë“œ (ìë©´ë™ ë‹¨ìœ„)
vulnerability_data = pd.read_csv('data/processed/202506_ìë©´ë™_ì‚¬íšŒì·¨ì•½ê³„ì¸µí‘œ.csv')

# ìˆ˜ë„ì¸í”„ë¼ ë°ì´í„° ë¡œë“œ
sewer_data = pd.read_csv('results/sewer_infrastructure_analysis_summary.csv')

# ì£¼ê±°ì·¨ì•½ì„± ë°ì´í„° ë¡œë“œ
housing_data = pd.read_csv('results/housing_vulnerability_analysis.csv')

# ë²•ì •ë™ì½”ë“œ ë°ì´í„° ë¡œë“œ
cd = pd.read_excel('data/raw/KIKcd_H.20250714_processed.xlsx')

# ---------------------------
# 3) ì •ê·œí™” í•¨ìˆ˜ ì •ì˜ (ì‚¬íšŒì·¨ì•½ê³„ì¸µ ë…¸íŠ¸ë¶ì—ì„œ ê°€ì ¸ì˜´)
# ---------------------------
def norm_gu(name):
    if pd.isna(name) or name == '':       # ë¹ˆ ë¬¸ìì—´ ë°©ì§€
        return ''
    return str(name).split()[-1]

def norm_dong(name):
    if pd.isna(name): 
        return name
    s = str(name).strip()
    # ì°½ì œ1ë™, ë‹¹ê°ì œ1ë™ ë“±: 'ì œìˆ«ì' â†’ 'ìˆ«ì'
    s = re.sub(r'ì œ(\d+)', r'\1', s)
    # êµ¬ë¶„ ê¸°í˜¸ í†µì¼ í›„ ì œê±°
    s = s.replace('.', 'Â·').replace('Â·', '').replace('ã†','')
    return s

# ---------------------------
# 4) ë°ì´í„° ì „ì²˜ë¦¬ ë° ê²°í•©
# ---------------------------
# ê¸°ì¡´ ì·¨ì•½ì„± ë°ì´í„° ì²˜ë¦¬ (ìë©´ë™ ë‹¨ìœ„ ìœ ì§€)
total = vulnerability_data.copy()

# ìˆ˜ë„ì¸í”„ë¼ ë°ì´í„°ë¥¼ ì‹œë„ ë‹¨ìœ„ë¡œ ì§‘ê³„
sewer_sido = sewer_data.groupby('ì‹œë„').agg({
    'í•˜ìˆ˜ë„_ì¸í”„ë¼_ì§€ìˆ˜': 'mean',
    'ì¸í”„ë¼_ë“±ê¸‰': lambda x: x.mode()[0] if len(x.mode()) > 0 else 'ë³´í†µ'
}).reset_index()

# ì£¼ê±°ì·¨ì•½ì„± ë°ì´í„° ì²˜ë¦¬ (ì´ë¯¸ ì‹œë„ ë‹¨ìœ„)
housing_sido = housing_data.copy()

# ì‹œë„ëª… ë§¤í•‘ í•¨ìˆ˜
def map_sido_name(sido_name):
    mapping = {
        'ì„œìš¸íŠ¹ë³„ì‹œ': 'ì„œìš¸íŠ¹ë³„ì‹œ',
        'ë¶€ì‚°ê´‘ì—­ì‹œ': 'ë¶€ì‚°ê´‘ì—­ì‹œ',
        'ëŒ€êµ¬ê´‘ì—­ì‹œ': 'ëŒ€êµ¬ê´‘ì—­ì‹œ',
        'ì¸ì²œê´‘ì—­ì‹œ': 'ì¸ì²œê´‘ì—­ì‹œ',
        'ê´‘ì£¼ê´‘ì—­ì‹œ': 'ê´‘ì£¼ê´‘ì—­ì‹œ',
        'ëŒ€ì „ê´‘ì—­ì‹œ': 'ëŒ€ì „ê´‘ì—­ì‹œ',
        'ìš¸ì‚°ê´‘ì—­ì‹œ': 'ìš¸ì‚°ê´‘ì—­ì‹œ',
        'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ': 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ',
        'ê²½ê¸°ë„': 'ê²½ê¸°ë„',
        'ê°•ì›ë„': 'ê°•ì›ë„',
        'ì¶©ì²­ë¶ë„': 'ì¶©ì²­ë¶ë„',
        'ì¶©ì²­ë‚¨ë„': 'ì¶©ì²­ë‚¨ë„',
        'ì „ë¼ë¶ë„': 'ì „ë¼ë¶ë„',
        'ì „ë¼ë‚¨ë„': 'ì „ë¼ë‚¨ë„',
        'ê²½ìƒë¶ë„': 'ê²½ìƒë¶ë„',
        'ê²½ìƒë‚¨ë„': 'ê²½ìƒë‚¨ë„',
        'ì œì£¼íŠ¹ë³„ìì¹˜ë„': 'ì œì£¼íŠ¹ë³„ìì¹˜ë„'
    }
    return mapping.get(sido_name, sido_name)

# ë°ì´í„° ê²°í•©
total['ì‹œë„ëª…'] = total['ì‹œë„ëª…'].apply(map_sido_name)
sewer_sido['ì‹œë„'] = sewer_sido['ì‹œë„'].apply(map_sido_name)
housing_sido['region'] = housing_sido['region'].apply(map_sido_name)

# ê°•ìˆ˜ëŸ‰ ë°ì´í„°ëŠ” ë³„ë„ë¡œ ìƒì„± (ì„ì‹œ ë°ì´í„°)
total['ì—°ê°•ìˆ˜ëŸ‰'] = np.random.uniform(800, 1400, len(total))

# ìˆ˜ë„ì¸í”„ë¼ ë°ì´í„°ë¥¼ ì‹œë„ë³„ë¡œ ìë©´ë™ì— ë§¤í•‘
total = total.merge(sewer_sido, left_on='ì‹œë„ëª…', right_on='ì‹œë„', how='left')

# ì£¼ê±°ì·¨ì•½ì„± ë°ì´í„°ë¥¼ ì‹œë„ë³„ë¡œ ìë©´ë™ì— ë§¤í•‘
total = total.merge(housing_sido, left_on='ì‹œë„ëª…', right_on='region', how='left')

# ê²°ì¸¡ê°’ ì²˜ë¦¬
total['í•˜ìˆ˜ë„_ì¸í”„ë¼_ì§€ìˆ˜'] = total['í•˜ìˆ˜ë„_ì¸í”„ë¼_ì§€ìˆ˜'].fillna(50)
total['vulnerability_normalized'] = total['vulnerability_normalized'].fillna(50)
total['ì¸í”„ë¼_ë“±ê¸‰'] = total['ì¸í”„ë¼_ë“±ê¸‰'].fillna('ë³´í†µ')
total['vulnerability_level'] = total['vulnerability_level'].fillna('ë³´í†µ')

# ì·¨ì•½ë“±ê¸‰ ê³„ì‚°
def grade(x):
    if x is None or (isinstance(x, float) and np.isnan(x)):
        return 1
    if x < 25:
        return 1
    elif x < 50:
        return 2
    elif x < 75:
        return 3
    else:
        return 4

def classify_infrastructure(score):
    if score >= 80:
        return 'ë†’ìŒ'
    elif score >= 60:
        return 'ë³´í†µ'
    elif score >= 40:
        return 'ë‚®ìŒ'
    else:
        return 'ë§¤ìš° ë‚®ìŒ'

def classify_vulnerability(score):
    if score >= 70:
        return 'ë§¤ìš° ë†’ìŒ'
    elif score >= 50:
        return 'ë†’ìŒ'
    elif score >= 30:
        return 'ë³´í†µ'
    elif score >= 10:
        return 'ë‚®ìŒ'
    else:
        return 'ë§¤ìš° ë‚®ìŒ'

def grade_to_number(grade):
    grade_mapping = {
        'ë§¤ìš° ë‚®ìŒ': 1,
        'ë‚®ìŒ': 2,
        'ë³´í†µ': 3,
        'ë†’ìŒ': 4,
        'ë§¤ìš° ë†’ìŒ': 5
    }
    return grade_mapping.get(grade, 3)

total['ì·¨ì•½ë“±ê¸‰'] = total['ì‚¬íšŒì·¨ì•½ì§€ìˆ˜'].apply(grade)
total['ìˆ˜ë„ì¸í”„ë¼_ë“±ê¸‰'] = total['í•˜ìˆ˜ë„_ì¸í”„ë¼_ì§€ìˆ˜'].apply(classify_infrastructure)
total['ì£¼ê±°ì·¨ì•½_ë“±ê¸‰'] = total['vulnerability_normalized'].apply(classify_vulnerability)

# ë“±ê¸‰ì„ ìˆ«ìë¡œ ë³€í™˜
total['ìˆ˜ë„ì¸í”„ë¼_ë“±ê¸‰_ìˆ«ì'] = total['ìˆ˜ë„ì¸í”„ë¼_ë“±ê¸‰'].apply(grade_to_number)
total['ì£¼ê±°ì·¨ì•½_ë“±ê¸‰_ìˆ«ì'] = total['ì£¼ê±°ì·¨ì•½_ë“±ê¸‰'].apply(grade_to_number)

# ---------------------------
# 5) ìµœê°•í™”ëœ ë§¤í•‘ (ë²•ì •ë™ì½”ë“œ í™œìš©)
# ---------------------------
# ê¸°ì¡´ ë°ì´í„°ì— ì´ë¯¸ í–‰ì •ë™ì½”ë“œê°€ ìˆëŠ”ì§€ í™•ì¸
if 'í–‰ì •ë™ì½”ë“œ' in total.columns:
    print("ê¸°ì¡´ ë°ì´í„°ì— í–‰ì •ë™ì½”ë“œê°€ ìˆìŠµë‹ˆë‹¤. ì •ê·œí™”ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.")
    # í–‰ì •ë™ì½”ë“œ ì •ê·œí™”
    total["í–‰ì •ë™ì½”ë“œ"] = (
        total["í–‰ì •ë™ì½”ë“œ"]
            .astype(str)                 # 3611025000  or  3611025000.0
            .str.split(".").str[0]        # 3611025000  (ì†Œìˆ˜ì  ì œê±°)
            .str.zfill(10)                # 10ìë¦¬ 0íŒ¨ë”© (0012312345 ê°™ì€ ì½”ë“œ ëŒ€ë¹„)
            .str.strip()                  # í˜¹ì‹œ ëª¨ë¥¼ ê³µë°± ì œê±°
    )
else:
    print("ê¸°ì¡´ ë°ì´í„°ì— í–‰ì •ë™ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ë²•ì •ë™ì½”ë“œ ë§¤í•‘ì„ ì§„í–‰í•©ë‹ˆë‹¤.")
    # ë²•ì •ë™ì½”ë“œ ë°ì´í„° ì „ì²˜ë¦¬
    cd.loc[(cd['ì‹œë„ëª…']=='ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ') & (cd['ì‹œêµ°êµ¬ëª…'].isna()), 'ì‹œêµ°êµ¬ëª…'] = 'ì„¸ì¢…ì‹œ'
    cd['ì‹œêµ°êµ¬ëª…'] = cd['ì‹œêµ°êµ¬ëª…'].fillna('')
    cd['key_gu']   = cd['ì‹œêµ°êµ¬ëª…'].apply(norm_gu)
    total['key_gu'] = total['ì‹œêµ°êµ¬ëª…'].apply(norm_gu)

    cd['key_dong']   = cd['ìë©´ë™ëª…'].apply(norm_dong)
    total['key_dong'] = total['ìë©´ë™ëª…'].apply(norm_dong)

    cd_sorted = (cd.sort_values(['ë§ì†Œì¼ì','ìƒì„±ì¼ì'])   # ë§ì†Œì¼ì NaN ì´ ë¨¼ì € ì˜´
                     .drop_duplicates(['ì‹œë„ëª…','key_gu','key_dong'],
                                       keep='last'))

    cd_subset = cd_sorted[['ì‹œë„ëª…','key_gu','key_dong','í–‰ì •ë™ì½”ë“œ']]

    # ìµœê°•í™”ëœ ë§¤í•‘ ì ìš©
    total = (total
             .merge(cd_subset,
                    left_on = ['ì‹œë„ëª…','key_gu','key_dong'],
                    right_on=['ì‹œë„ëª…','key_gu','key_dong'],
                    how='left')
             .drop(columns=['key_gu','key_dong'])      # ì •ê·œí™”ìš© ì»¬ëŸ¼ ì œê±°
            )

    # í–‰ì •ë™ì½”ë“œ ì •ê·œí™”
    if 'í–‰ì •ë™ì½”ë“œ' in total.columns:
        total["í–‰ì •ë™ì½”ë“œ"] = (
            total["í–‰ì •ë™ì½”ë“œ"]
                .astype(str)                 # 3611025000  or  3611025000.0
                .str.split(".").str[0]        # 3611025000  (ì†Œìˆ˜ì  ì œê±°)
                .str.zfill(10)                # 10ìë¦¬ 0íŒ¨ë”© (0012312345 ê°™ì€ ì½”ë“œ ëŒ€ë¹„)
                .str.strip()                  # í˜¹ì‹œ ëª¨ë¥¼ ê³µë°± ì œê±°
        )
    else:
        print("Warning: ë§¤í•‘ í›„ì—ë„ í–‰ì •ë™ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.")

# ---------------------------
# 6) GeoJSON featureì— ë°ì´í„° ë³‘í•©
# ---------------------------
# í–‰ì •ë™ì½”ë“œ ë§¤í•‘ (GeoJSONì—ì„œ)
code2name = {
    str(f['properties']['adm_cd2']): f['properties']['adm_nm']
    for f in geo_all['features']
}
total['í–‰ì •ë™ëª…'] = total['í–‰ì •ë™ì½”ë“œ'].astype(str).map(code2name)

# ìë©´ë™ë³„ ë°ì´í„°ë¥¼ ë”•ì…”ë„ˆë¦¬ë¡œ ë³€í™˜
emd_data_dict = total.set_index('í–‰ì •ë™ì½”ë“œ').to_dict(orient='index')

# ê¸°ë³¸ê°’ ì„¤ì •
default_data = {
    'ì‚¬íšŒì·¨ì•½ì§€ìˆ˜': 30.0,
    'ì—°ê°•ìˆ˜ëŸ‰': 1000.0,
    'í•˜ìˆ˜ë„_ì¸í”„ë¼_ì§€ìˆ˜': 50.0,
    'vulnerability_normalized': 50.0,
    'ì·¨ì•½ë“±ê¸‰': 2,
    'ìˆ˜ë„ì¸í”„ë¼_ë“±ê¸‰': 2,
    'ì£¼ê±°ì·¨ì•½_ë“±ê¸‰': 2,
    'ìˆ˜ë„ì¸í”„ë¼_ë“±ê¸‰_ìˆ«ì': 2,
    'ì£¼ê±°ì·¨ì•½_ë“±ê¸‰_ìˆ«ì': 2,
    'ì¸í”„ë¼_ë“±ê¸‰': 'ë³´í†µ',
    'vulnerability_level': 'ë³´í†µ'
}

# GeoJSON featureì— ë°ì´í„° ì¶”ê°€
for feat in geo_all['features']:
    c = str(feat['properties'].get('adm_cd2', ''))
    row = emd_data_dict.get(c)
    if row:
        feat['properties'].update({
            'ì‚¬íšŒì·¨ì•½ì§€ìˆ˜': row.get('ì‚¬íšŒì·¨ì•½ì§€ìˆ˜', default_data['ì‚¬íšŒì·¨ì•½ì§€ìˆ˜']),
            'ì—°ê°•ìˆ˜ëŸ‰': row.get('ì—°ê°•ìˆ˜ëŸ‰', default_data['ì—°ê°•ìˆ˜ëŸ‰']),
            'í•˜ìˆ˜ë„_ì¸í”„ë¼_ì§€ìˆ˜': row.get('í•˜ìˆ˜ë„_ì¸í”„ë¼_ì§€ìˆ˜', default_data['í•˜ìˆ˜ë„_ì¸í”„ë¼_ì§€ìˆ˜']),
            'vulnerability_normalized': row.get('vulnerability_normalized', default_data['vulnerability_normalized']),
            'ì·¨ì•½ë“±ê¸‰': row.get('ì·¨ì•½ë“±ê¸‰', default_data['ì·¨ì•½ë“±ê¸‰']),
            'ìˆ˜ë„ì¸í”„ë¼_ë“±ê¸‰': row.get('ìˆ˜ë„ì¸í”„ë¼_ë“±ê¸‰', default_data['ìˆ˜ë„ì¸í”„ë¼_ë“±ê¸‰']),
            'ì£¼ê±°ì·¨ì•½_ë“±ê¸‰': row.get('ì£¼ê±°ì·¨ì•½_ë“±ê¸‰', default_data['ì£¼ê±°ì·¨ì•½_ë“±ê¸‰']),
            'ìˆ˜ë„ì¸í”„ë¼_ë“±ê¸‰_ìˆ«ì': row.get('ìˆ˜ë„ì¸í”„ë¼_ë“±ê¸‰_ìˆ«ì', default_data['ìˆ˜ë„ì¸í”„ë¼_ë“±ê¸‰_ìˆ«ì']),
            'ì£¼ê±°ì·¨ì•½_ë“±ê¸‰_ìˆ«ì': row.get('ì£¼ê±°ì·¨ì•½_ë“±ê¸‰_ìˆ«ì', default_data['ì£¼ê±°ì·¨ì•½_ë“±ê¸‰_ìˆ«ì']),
            'ì¸í”„ë¼_ë“±ê¸‰': row.get('ì¸í”„ë¼_ë“±ê¸‰', default_data['ì¸í”„ë¼_ë“±ê¸‰']),
            'vulnerability_level': row.get('vulnerability_level', default_data['vulnerability_level'])
        })
    else:
        default_data['ì‚¬íšŒì·¨ì•½ì§€ìˆ˜'] = round(random.uniform(5, 20), 5)
        feat['properties'].update(default_data)

# ë°ì´í„° ê°’ ë²”ìœ„ í™•ì¸ ë° bins ì¡°ì •
print("ë°ì´í„° ê°’ ë²”ìœ„:")
print(f"ì‚¬íšŒì·¨ì•½ì§€ìˆ˜: {total['ì‚¬íšŒì·¨ì•½ì§€ìˆ˜'].min():.2f} ~ {total['ì‚¬íšŒì·¨ì•½ì§€ìˆ˜'].max():.2f}")
print(f"ì—°ê°•ìˆ˜ëŸ‰: {total['ì—°ê°•ìˆ˜ëŸ‰'].min():.2f} ~ {total['ì—°ê°•ìˆ˜ëŸ‰'].max():.2f}")
print(f"í•˜ìˆ˜ë„_ì¸í”„ë¼_ì§€ìˆ˜: {total['í•˜ìˆ˜ë„_ì¸í”„ë¼_ì§€ìˆ˜'].min():.2f} ~ {total['í•˜ìˆ˜ë„_ì¸í”„ë¼_ì§€ìˆ˜'].max():.2f}")
print(f"vulnerability_normalized: {total['vulnerability_normalized'].min():.2f} ~ {total['vulnerability_normalized'].max():.2f}")

# ---------------------------
# 7) ê° ì§€ë„ë³„ ì„¤ì •
# ---------------------------
MAP_CONFIGS = {
    "í†µí•©ì·¨ì•½ì§€ìˆ˜": {
        "col": "ì‚¬íšŒì·¨ì•½ì§€ìˆ˜",
        "palette": "RdPu",
        "bins": [0, 25, 50, 75, 100],
        "fmt": "{:.0f}%",
        "chart_color": "#fa9fb5",
        "title": "í†µí•© ì·¨ì•½ì§€ìˆ˜"
    },
    "ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜": {
        "col": "ìˆ˜ë„ì¸í”„ë¼_ë“±ê¸‰_ìˆ«ì",
        "palette": "Purples",
        "bins": [0.5, 1.5, 2.5, 3.5, 4.5, 5.5],
        "fmt": "ë“±ê¸‰",
        "chart_color": "#9e9ac8",
        "title": "ìˆ˜ë„ ì¸í”„ë¼ ì§€ìˆ˜"
    },
    "ì£¼ê±°ì·¨ì•½ì§€ìˆ˜": {
        "col": "ì£¼ê±°ì·¨ì•½_ë“±ê¸‰_ìˆ«ì",
        "palette": "Greens",
        "bins": [0.5, 1.5, 2.5, 3.5, 4.5, 5.5],
        "fmt": "ë“±ê¸‰",
        "chart_color": "#74c476",
        "title": "ì£¼ê±° ì·¨ì•½ì§€ìˆ˜"
    }
}

# ---------------------------
# 8) ê° ì§€ë„ ìƒì„±
# ---------------------------
maps = {}
for map_name, config in MAP_CONFIGS.items():
    m = folium.Map(location=[36, 127], zoom_start=7,
                   tiles='cartodbpositron', control_scale=True)
    
    # Choropleth ìƒì„±
    ch = folium.Choropleth(
        geo_data=geo_all,
        data=total,
        columns=('í–‰ì •ë™ì½”ë“œ', config['col']),
        key_on='feature.properties.adm_cd2',
        fill_color=config['palette'],
        bins=config['bins'],
        fill_opacity=0.85,
        line_opacity=0.3,
        line_weight=0.4,
        nan_fill_color='#fde0dd',
        name=config['title'],
        show=True,
    ).add_to(m)
    
    # íˆ´íŒ ì„¤ì •
    if map_name == "ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜":
        tooltip_fields = ['adm_nm', 'í•˜ìˆ˜ë„_ì¸í”„ë¼_ì§€ìˆ˜', 'ìˆ˜ë„ì¸í”„ë¼_ë“±ê¸‰']
        tooltip_aliases = ['í–‰ì •ë™', 'ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜', 'ìˆ˜ë„ì¸í”„ë¼ë“±ê¸‰']
    elif map_name == "ì£¼ê±°ì·¨ì•½ì§€ìˆ˜":
        tooltip_fields = ['adm_nm', 'vulnerability_normalized', 'ì£¼ê±°ì·¨ì•½_ë“±ê¸‰']
        tooltip_aliases = ['í–‰ì •ë™', 'ì£¼ê±°ì·¨ì•½ì§€ìˆ˜', 'ì£¼ê±°ì·¨ì•½ë“±ê¸‰']
    else:
        tooltip_fields = ['adm_nm', config['col'], 'ì·¨ì•½ë“±ê¸‰']
        tooltip_aliases = ['í–‰ì •ë™', config['title'], 'ì·¨ì•½ë“±ê¸‰']
    
    GeoJsonTooltip(
        fields=tooltip_fields,
        aliases=tooltip_aliases,
        localize=True,
        labels=True,
        sticky=False,
        style=(
            "background-color:rgba(255,255,255,.9);"
            "border:1px solid #999;border-radius:3px;"
            "box-shadow:2px 2px 6px rgba(0,0,0,.15);"
            "font-size:12px;padding:4px;"
        )
    ).add_to(ch.geojson)
    
    maps[map_name] = m

# ---------------------------
# 9) HTML í…œí”Œë¦¿ ìƒì„± (íƒ­ í˜•íƒœ)
# ---------------------------
html_template = """
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>í†µí•© ì·¨ì•½ì„± ì§€ë„</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', 'NanumGothic', sans-serif;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        .tab-container {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .tab:hover {
            background: #e9ecef;
            color: #495057;
        }
        .tab.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
        }
        .map-container {
            display: none;
            height: 700px;
            position: relative;
        }
        .map-container.active {
            display: block;
        }
        .map-frame {
            width: 100%;
            height: 100%;
            border: none;
        }
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .legend h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #333;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 12px;
        }
        .legend-color {
            width: 20px;
            height: 15px;
            margin-right: 8px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‡°ğŸ‡· í•œêµ­ í†µí•© ì·¨ì•½ì„± ì§€ë„</h1>
            <p>ì‚¬íšŒì·¨ì•½ì§€ìˆ˜, ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜, ì£¼ê±°ì·¨ì•½ì§€ìˆ˜ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
        </div>
        
        <div class="tab-container">
            <button class="tab active" onclick="showMap('í†µí•©ì·¨ì•½ì§€ìˆ˜')">í†µí•© ì·¨ì•½ì§€ìˆ˜</button>
            <button class="tab" onclick="showMap('ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜')">ìˆ˜ë„ ì¸í”„ë¼ ì§€ìˆ˜</button>
            <button class="tab" onclick="showMap('ì£¼ê±°ì·¨ì•½ì§€ìˆ˜')">ì£¼ê±° ì·¨ì•½ì§€ìˆ˜</button>
        </div>
        
        <div id="í†µí•©ì·¨ì•½ì§€ìˆ˜" class="map-container active">
            <iframe class="map-frame" src="korea_vulnerability_map.html"></iframe>
        </div>
        
        <div id="ìˆ˜ë„ì¸í”„ë¼ì§€ìˆ˜" class="map-container">
            <iframe class="map-frame" src="sewer_infrastructure_map.html"></iframe>
        </div>
        
        <div id="ì£¼ê±°ì·¨ì•½ì§€ìˆ˜" class="map-container">
            <iframe class="map-frame" src="housing_vulnerability_map.html"></iframe>
        </div>
    </div>
    
    <script>
        function showMap(mapName) {
            // ëª¨ë“  íƒ­ê³¼ ë§µ ì»¨í…Œì´ë„ˆ ë¹„í™œì„±í™”
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.map-container').forEach(container => {
                container.classList.remove('active');
            });
            
            // ì„ íƒëœ íƒ­ê³¼ ë§µ ì»¨í…Œì´ë„ˆ í™œì„±í™”
            event.target.classList.add('active');
            document.getElementById(mapName).classList.add('active');
        }
    </script>
</body>
</html>
"""

# ---------------------------
# 10) HTML íŒŒì¼ ì €ì¥
# ---------------------------
output_path = 'results/integrated_vulnerability_map.html'
os.makedirs(os.path.dirname(output_path), exist_ok=True)

with open(output_path, 'w', encoding='utf-8') as f:
    f.write(html_template)

print(f"âœ”ï¸ í†µí•© ì§€ë„ ì €ì¥ ì™„ë£Œ: {output_path}")
print("ğŸ“‹ ê° ì§€ë„ê°€ íƒ­ í˜•íƒœë¡œ í†µí•©ë˜ì–´ í‘œì‹œë©ë‹ˆë‹¤:")
print("   - í†µí•© ì·¨ì•½ì§€ìˆ˜: korea_vulnerability_map.html")
print("   - ìˆ˜ë„ ì¸í”„ë¼ ì§€ìˆ˜: sewer_infrastructure_map.html") 
print("   - ì£¼ê±° ì·¨ì•½ì§€ìˆ˜: housing_vulnerability_map.html") 